trigger:
- none

variables:
- name: checkContext
  value: Pipeline validation
- name: checkDescription
  value: AzDO pipeline check - state.txt

resources:
  webhooks:
    - webhook: githubpr
      connection: github__pahealy7__apim-configuation__pr
  repositories:
    - repository: githubrepo
      type: github
      endpoint: phealy
      name: phealy/apim-configuration

pool:
  vmImage: ubuntu-latest

jobs:
- job: performCheckout
  displayName: Perform checkout
  condition: in('${{ parameters.githubpr.action }}', 'opened', 'reopened', 'edited', 'synchronize')
  steps:
  - checkout: githubrepo
    persistCredentials: true
    # persistCredentials allows us to use the PAT generated by AzDO to post to the status API below.

  - script: |
      set -euxo pipefail
      git fetch origin pull/${{ parameters.githubpr.number }}/head:pr
      git checkout pr
      git status
    displayName: Switch branch to pull request head

  - script: |
      echo "##vso[task.setvariable variable=pipelineResult]$(cat state.txt)"
      echo "Set pipelineResult to '$(cat state.txt)'."
    displayName: Perform checkout

  - script: |
      GIT_REMOTE=$(git config --get remote.origin.url)
      GIT_AUTH=$(git config --get "http.${GIT_REMOTE}.extraheader")
      
      cat > statusPost.json << EOF
      {
        "state":"$(pipelineResult)",
        "context":"$(checkContext),
        "description":"$(checkDescription)",
        "target_url":"$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
      }
      EOF

      echo "Status post to ${{ parameters.githubpr.pull_request.statuses_url }}:"
      cat statusPost.json

      curl -H "Accept: application/vnd.github.v3+json" \
        -H "Content-Type: application/json" \
        -H "${GIT_AUTH}" \
        -X POST \
        '${{ parameters.githubpr.pull_request.statuses_url }}' \
        --data @statusPost.json
    displayName: Post commit status
